<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>HlearnHub - Personal Schedule</title>
  <meta name="description" content="HlearnHub student learning platform - Schedule page">
  <meta name="keywords" content="education, tutoring, online learning, schedule">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&family=Poppins:wght@100;200;300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="assets/css/main.css" rel="stylesheet">
  
  <style>
    :root {
      --primary-color: #AA261B;
      --secondary-color: #AA261B;
      --accent-color: #AA261B;
      --light-color: #fff;
      --dark-color: #34495e;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --overdue-color:#e74c3c;
      --upcoming-color: #2ecc71;
      --current-color: #f39c12;
      --tick-color:#3498db;
    }
    
    body {
      font-family: 'Open Sans', sans-serif;
      color: #444;
      background-color: #d7d5d5c4;
    } 
    
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Poppins', sans-serif;
      color: #444;
      font-weight: 600;
    }
    
    /* Schedule page specific styles */
    .page-title {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }
    
    .page-title h2 {
      color: white;
      margin-bottom: 10px;
    }
    
    .schedule-tabs .nav-tabs {
      border: none;
      margin-bottom: 30px;
    }
    
    .schedule-tabs .nav-link {
      font-weight: 600;
      color: #444;
      border: none;
      padding: 15px 30px;
      border-radius: 50px;
      margin-right: 10px;
      transition: 0.3s;
    }
    
    .schedule-tabs .nav-link.active {
      background: var(--primary-color);
      color: white;
    }
    
    .schedule-tabs .nav-link:hover:not(.active) {
      background: rgba(170, 38, 27, 0.1);
    }
    
    /* Calendar styles */
    .calendar-header {
      background: var(--primary-color);
      color: white;
      border-radius: 15px 15px 0 0;
      padding: 20px;
      text-align: center;
    }
    
    .calendar-header h4 {
      color: white;
      margin: 0;
    }
    
    .calendar-body {
      background: white;
      border-radius: 0 0 15px 15px;
      padding: 20px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
    }
    
    .calendar-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .calendar-nav {
      display: flex;
      align-items: center;
    }
    
    .calendar-nav button {
      background: transparent;
      border: none;
      font-size: 20px;
      color: var(--primary-color);
      cursor: pointer;
    }
    
    .calendar-month {
      margin: 0 15px;
      font-weight: 600;
      font-size: 18px;
    }
    
    .calendar-view button {
      background: #f5f5f5;
      border: none;
      padding: 8px 15px;
      margin-left: 10px;
      border-radius: 5px;
      color: #444;
      cursor: pointer;
      transition: 0.3s;
    }
    
    .calendar-view button.active {
      background: var(--primary-color);
      color: white;
    }
    
    /* Event list styles */
    .schedule-container {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
    }
    
    .schedule-header {
      background: var(--primary-color);
      color: white;
      padding: 20px;
      font-size: 20px;
      font-weight: 600;
    }
    
    .schedule-body {
      padding: 20px;
    }
    
    .class-item {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid var(--accent-color);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      transition: transform 0.2s;
    }
    
    .class-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .class-date {
      width: 80px;
      min-width: 80px;
      text-align: center;
      border-right: 1px solid #eee;
      padding-right: 15px;
      margin-right: 15px;
    }
    
    .class-date .day {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .class-date .date {
      font-size: 14px;
      color: #777;
    }
    
    .class-info {
      flex-grow: 1;
    }
    
    .class-info h5 {
      font-size: 16px;
      margin-bottom: 5px;
      color: var(--primary-color);
    }
    
    .class-info p {
      font-size: 14px;
      margin-bottom: 5px;
      color: #777;
    }
    
    .class-time {
      display: flex;
      align-items: center;
      color: var(--accent-color);
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 0;
    }
    
    .class-time i {
      margin-right: 5px;
    }
    
    .class-actions {
      min-width: 120px;
      text-align: right;
    }
    
    .action-btn {
      background: #f5f5f5;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      color: #444;
      margin-left: 5px;
      cursor: pointer;
      transition: 0.3s;
      font-size: 14px;
    }
    
    .action-btn.primary {
      background: var(--primary-color);
      color: white;
    }
    
    .action-btn:hover {
      opacity: 0.8;
    }
    
    .class-item.math {
      border-left-color: #2ecc71;
    }
    
    .class-item.english {
      border-left-color: #3498db;
    }
    
    .class-item.physics {
      border-left-color: #f39c12;
    }
    
    .class-item.cs {
      border-left-color: var(--overdue-color);
    }
    
    .class-item.chemistry {
      border-left-color: #e74c3c;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .status-upcoming {
      background: rgba(46, 204, 113, 0.15);
      color: #2ecc71;
    }
    
    .status-ongoing {
      background: rgba(243, 156, 18, 0.15);
      color: #f39c12;
    }
    
    .status-completed {
      background: rgba(231, 76, 60, 0.15);
      color: #e74c3c;
    }
    
    /* Filter panel styles from first file */
    .filter-panel {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
    }
    
    .schedule-type-selector {
      background: white;
      border-radius: 15px;
      margin-bottom: 20px;
    }
    
    .schedule-type-options {
      margin-top: 15px;
    }
    
    .btn-schedule {
      flex: 1;
      padding: 12px;
      border: 1px solid #e9ecef;
      background-color: #f8f9fa;
      color: #495057;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-schedule:first-child {
      border-radius: 8px 0 0 8px;
    }
    
    .btn-schedule:last-child {
      border-radius: 0 8px 8px 0;
    }
    
    .btn-schedule.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
      box-shadow: 0 2px 10px rgba(170, 38, 27, 0.3);
    }
    
    .btn-schedule:hover:not(.active) {
      background-color: rgba(170, 38, 27, 0.1);
    }
    
    .filter-header {
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .filter-reset {
      color: var(--primary-color);
      font-size: 14px;
      cursor: pointer;
      text-decoration: underline;
    }
    
    .filter-group {
      margin-bottom: 15px;
    }
    
    .filter-group-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #495057;
    }
    
    .filter-option {
      margin-bottom: 8px;
      display: flex;
      align-items: center;
    }
    
    .filter-option input[type="checkbox"] {
      margin-right: 8px;
      cursor: pointer;
    }
    
    .filter-option label {
      margin-bottom: 0;
      font-size: 14px;
      cursor: pointer;
    }
    
    .date-range .form-control {
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }
    
    .date-range .form-label {
      font-size: 13px;
      margin-bottom: 5px;
    }
    
    .apply-filter-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 20px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .apply-filter-btn:hover {
      background-color: #8a1e16;
      box-shadow: 0 2px 10px rgba(170, 38, 27, 0.3);
    }
    
    /* Responsive adjustments */
    @media (max-width: 992px) {
      .schedule-tabs .nav-link {
        padding: 10px 20px;
        font-size: 14px;
      }
    }
    
    @media (max-width: 768px) {
      .filter-group {
        margin-bottom: 20px;
      }
      
      .class-actions {
        width: 100%;
        text-align: left;
        margin-top: 10px;
        display: flex;
        justify-content: space-between;
      }
      
      .class-item {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .class-date {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #eee;
        padding-right: 0;
        padding-bottom: 10px;
        margin-right: 0;
        margin-bottom: 10px;
        text-align: left;
        display: flex;
        align-items: center;
      }
      
      .class-date .day {
        margin-right: 10px;
      }
      
      .schedule-tabs .nav-link {
        margin-bottom: 10px;
      }
    }

    /* Filter Section */
    .filter-section {
      background: white;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      padding: 30px;
      margin-bottom: 30px;
    }

    .filter-section h3 {
      color: var(--primary-color);
      margin-bottom: 25px;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
    }

    .form-label {
      color: var(--primary-color);
      font-weight: 600;
      margin-bottom: 8px;
    }

    .form-control,
    .form-select {
      border: 2px solid #e9ecef;
      border-radius: 10px;
      padding: 12px 15px;
      transition: all 0.3s;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(170, 38, 27, 0.15);
    }

    .btn-search {
      background: var(--primary-color);
      border: none;
      color: white;
      padding: 12px 30px;
      border-radius: 25px;
      font-weight: 600;
      transition: all 0.3s;
      width: 100%;
      margin-top: 20px;
    }

    .btn-search:hover {
      background: #8a1e15;
      transform: translateY(-2px);
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header id="header" class="header d-flex align-items-center sticky-top">
    <div class="container-fluid container-xl position-relative d-flex align-items-center">
      <a href="/" class="logo d-flex align-items-center me-auto">
        <h1 class="sitename">HlearnHub</h1>
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="/">Trang chủ</a></li>
          <li><a href="/about">Về chúng tôi</a></li>
          <li><a href="/dayVaHoc">Dạy và học</a></li>
          <li><a href="/schedule" class="active">Lịch cá nhân</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>

      <a class="btn-getstarted" href="/profile"><i class="bi bi-person-circle me-2"></i><span id="user-nickname"></span></a>
    </div>
  </header>

  <main class="main py-5">
    <div class="container">
      <!-- Page title -->
      <div class="page-title mb-5" data-aos="fade-up">
        <div class="row align-items-center">
          <div class="col-lg-8">
            <h2>Lịch cá nhân</h2>
            <p>Quản lý lịch dạy và lịch học của bạn tại đây.</p>
          </div>
          <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
            <div class="today-date">
              <span id="currentDay">Thứ Tư</span>, <span id="currentDate">30/04/2025</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Filter Criteria Box from first file -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="filter-section">
            <h3><i class="bi bi-funnel-fill me-2"></i>Bộ Lọc Tìm Kiếm</h3>
            <div class="row">
              <div class="col-md-2 mb-3">
                <label for="start-time" class="form-label">Giờ bắt đầu</label>
                <input type="time" class="form-control" id="start-time">
              </div>
              <div class="col-md-2 mb-3">
                <label for="end-time" class="form-label">Giờ kết thúc</label>
                <input type="time" class="form-control" id="end-time">
              </div>
              <div class="col-md-2 mb-3">
                <label for="date" class="form-label">Ngày</label>
                <input type="date" class="form-control" id="date">
              </div>
              <div class="col-md-2 mb-3">
                <label for="status" class="form-label">Trạng thái</label>
                <select class="form-select" id="status">
                  <option value="">Tất cả trạng thái</option>
                  <option value="upcoming">Sắp tới</option>
                  <option value="ongoing">Đang diễn ra</option>
                  <option value="completed">Kết thúc</option>
                </select>
              </div>
              <div class="col-md-2 mb-3">
                <label for="subject" class="form-label">Môn học</label>
                <select class="form-select" id="subject">
                  <option value="">Tất cả môn học</option>
                  <option value="Calculus 1">Giải tích I</option>
                  <option value="Calculus 2">Giải tích II</option>
                  <option value="Calculus 3">Giải tích III</option>
                  <option value="Probability and Statistics">Xác suất thống kê</option>
                  <option value="linear Algebra">Đại số tuyến tính</option>
                  <option value="Physics">Vật lý đại cương</option>
                  <option value="Chemistry">Hóa học đại cương</option>
                  <option value="English">Tiếng Anh cơ bản</option>
                  <option value="Philosophy">Triết học Mác-Lênin</option>
                  <option value="Economics">Kinh tế chính trị</option>
                </select>
              </div>
              <div class="col-md-2 mb-3">
                <label for="sort" class="form-label">Sắp xếp</label>
                <select class="form-select" id="sort">
                  <option value="date-asc">Ngày tăng dần</option>
                  <option value="date-desc">Ngày giảm dần</option>
                  <option value="time-asc">Giờ tăng dần</option>
                  <option value="time-desc">Giờ giảm dần</option>
                  <option value="subject-asc">Môn học A-Z</option>
                  <option value="subject-desc">Môn học Z-A</option>
                </select>
              </div>
              <div class="col-12">
                <button class="btn btn-search" onclick="filterRequests()">
                  <i class="bi bi-search me-2"></i>Tìm Kiếm
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Schedule tabs -->
      <div class="schedule-tabs" data-aos="fade-up">
        <ul class="nav nav-tabs" id="scheduleTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="teaching-tab" data-bs-toggle="tab" data-bs-target="#teaching-tab-pane" type="button" role="tab" aria-controls="teaching-tab-pane" aria-selected="true">
              <i class="bi bi-mortarboard-fill me-2"></i>Lịch dạy
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="learning-tab" data-bs-toggle="tab" data-bs-target="#learning-tab-pane" type="button" role="tab" aria-controls="learning-tab-pane" aria-selected="false">
              <i class="bi bi-book me-2"></i>Lịch học
            </button>
          </li>
        </ul>
        
        <div class="tab-content" id="scheduleTabContent">
          <!-- Teaching schedule tab -->
          <div class="tab-pane fade show active" id="teaching-tab-pane" role="tabpanel" aria-labelledby="teaching-tab" tabindex="0">
            
            <!-- Teaching schedule content -->
            <div class="schedule-container mb-4">
              <div class="schedule-header">
                <i class="bi bi-calendar-week me-2"></i> Lịch dạy
              </div>
              <div class="schedule-body">
                <!-- Teaching class items -->
                
              </div>
            </div>
          </div>
          
          <!-- Learning schedule tab -->
          <div class="tab-pane fade" id="learning-tab-pane" role="tabpanel" aria-labelledby="learning-tab" tabindex="0">
            <!-- Learning schedule content -->
            <div class="schedule-container mb-4">
              <div class="schedule-header">
                <i class="bi bi-calendar-week me-2"></i> Lịch học
              </div>
              <div class="schedule-body">
                <!-- Nội dung lịch học sẽ được thêm vào đây -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer id="footer" class="footer">
    <div class="container footer-top">
      <div class="row gy-4">
        <div class="col-lg-5 col-md-12 footer-info">
          <div class="footer-logo">Hlearn<span>Hub</span></div>
          <p class="footer-subtitle">HlearnHub – Học cùng nhau, vững bước cùng nhau.</p>
          <div class="footer-social">
            <a href="#"><i class="bi bi-twitter-x"></i></a>
            <a href="#"><i class="bi bi-facebook"></i></a>
            <a href="#"><i class="bi bi-instagram"></i></a>
            <a href="#"><i class="bi bi-linkedin"></i></a>
          </div>
        </div>
        
        <div class="col-lg-7 col-md-12">
          <div class="row">
            <div class="col-lg-4 col-6 footer-links">
              <div class="footer-contact">
                <p><i class="bi bi-geo-alt me-2"></i> Số 1 Đại Cồ Việt, Hai Bà Trưng, Hà Nội</p>
                <p><i class="bi bi-telephone me-2"></i> +84 123 456 789</p>
                <p><i class="bi bi-envelope me-2"></i> info@hlearnhub.com</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="container copyright text-center mt-4">
      <p>&copy; <span>2025</span> <strong>HlearnHub</strong>. All Rights Reserved</p>
    </div>
  </footer>

  <!-- Bootstrap JS and other scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <!-- Custom JavaScript -->
  <script>
    const firebaseConfig = {
    apiKey: "AIzaSyAWXMEwMPSyMBVf4LikdsVCZ0kN4BhYB6E",
    authDomain: "hlearnhub-testing.firebaseapp.com",
    projectId: "hlearnhub-testing",
    messagingSenderId: "1054297107041",
    appId: "1:1054297107041:web:e2e985461b9ac570441820"
  };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    // Lấy thời gian cụ thể ở 
    document.addEventListener('DOMContentLoaded', function() {
      const now = new Date();
      const days = ['Chủ Nhật', 'Thứ Hai', 'Thứ Ba', 'Thứ Tư', 'Thứ Năm', 'Thứ Sáu', 'Thứ Bảy'];
      const day = days[now.getDay()];
      const date = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const year = now.getFullYear();
      
      document.getElementById('currentDay').textContent = day;
      document.getElementById('currentDate').textContent = `${date}/${month}/${year}`;
    });

 document.addEventListener('DOMContentLoaded', async () => {
  const uid = localStorage.getItem("uid");

  if (!uid) {
    document.querySelector("#learning-tab-pane .schedule-body").innerHTML = "Không tìm thấy tài khoản của bạn.";
    return;
  }

  try {
    // Sửa lại cách truy vấn document
    const userRef = db.collection("users").doc(uid);
    const userSnap = await userRef.get();

    if (!userSnap.exists) {
      alert("Không tìm thấy dữ liệu người dùng.");
      return;
    }

    const userData = userSnap.data();
    document.getElementById('user-nickname').textContent = userData.fullName || "Không có tên";
    
    // Gọi các hàm load lịch sau khi đã xác thực user
    await Promise.all([
      loadLearningSchedule(),
      loadTeachingSchedule()
    ]);

  } catch (err) {
    console.error("Lỗi khi lấy dữ liệu người dùng:", err);
    alert("Lỗi khi lấy dữ liệu người dùng: " + err.message);
  }
});

  // Định nghĩa các hàm load lịch một lần duy nhất
  async function loadLearningSchedule() {
    try {
      const uid = localStorage.getItem("uid");
      const q = db.collection("class").where("uid", "==", uid);
      const querySnapshot = await q.get();

      let html = "";
      let upcomingCount = 0;
      let completedCount = 0;

      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();

        // Chuyển đổi chuỗi ngày thành đối tượng Date
        const [year, month, day] = data.day.split('-');
        const date = new Date(Number(year), Number(month) - 1, Number(day));
        
        // Lấy thứ trong tuần
        const weekdays = ['Chủ Nhật', 'Thứ Hai', 'Thứ Ba', 'Thứ Tư', 'Thứ Năm', 'Thứ Sáu', 'Thứ Bảy'];
        const weekday = weekdays[date.getDay()];

        // Xác định trạng thái dựa trên thời gian hiện tại
        const now = new Date();
        const [startHour, startMinute] = data.start.split(':');
        const [endHour, endMinute] = data.end.split(':');
        
        // Tạo đối tượng Date cho thời gian bắt đầu và kết thúc
        const startTime = new Date(date);
        startTime.setHours(parseInt(startHour), parseInt(startMinute), 0);
        
        const endTime = new Date(date);
        endTime.setHours(parseInt(endHour), parseInt(endMinute), 0);

        let status = "Sắp tới";
        let statusClass = "status-upcoming";
        
        function getDateOnly(d) {
          return new Date(d.getFullYear(), d.getMonth(), d.getDate());
        }
        const classDate = getDateOnly(date);
        const today = getDateOnly(now);

        if (classDate < today) {
          // Nếu ngày học đã qua
          status = "Kết thúc";
          statusClass = "status-completed";
          completedCount++;
        } else if (classDate.getTime() === today.getTime()) {
          // Nếu là ngày hôm nay thì kiểm tra giờ
          if (now > endTime) {
            // Nếu đã qua giờ kết thúc
            status = "Kết thúc";
            statusClass = "status-completed";
            completedCount++;
          } else if (now >= startTime && now <= endTime) {
            // Nếu đang trong giờ học
            status = "Đang diễn ra";
            statusClass = "status-ongoing";
          } else {
            // Nếu chưa đến giờ bắt đầu
            status = "Sắp tới";
            statusClass = "status-upcoming";
            upcomingCount++;
          }
        } else {
          // Nếu là ngày trong tương lai
          status = "Sắp tới";
          statusClass = "status-upcoming";
          upcomingCount++;
        }

        // Xác định đường dẫn profile dựa trên trạng thái
        const profilePath = (status === "Kết thúc") ? "/profileOther" : "/profileOthernoReview";

        // Tạo HTML cho từng lớp học
        html += `
          <div class="class-item">
            <div class="class-date">
              <div class="day">${weekday}</div>
              <div class="date">${data.day}</div>
            </div>
            <div class="class-info">
              <span class="status-badge ${statusClass}">${status}</span>
              <h5>${data.generalSubject || "Không có tiêu đề"}</h5>
              <p>Gia sư: ${data.teacherName || "Không rõ"}</p>
              <p class="class-time"><i class="bi bi-clock"></i> ${data.start} - ${data.end}</p>
            </div>
            <div class="class-actions">
              <button class="action-btn"><i class="bi bi-info-circle"></i><a href="${profilePath}?uid=${data.teacherId}" class="tutor-name-link"> Chi tiết gia sư </a></button>
            </div>
          </div>
        `;
      });

      // Cập nhật số lớp vào Firestore
      try {
        await db.collection("users").doc(uid).update({
          upcomingStudySessions: upcomingCount,
          completedStudySessions: completedCount
        });
        console.log(`Cập nhật số lớp học - Sắp tới: ${upcomingCount}, Kết thúc: ${completedCount}`);
      } catch (error) {
        console.error("Lỗi khi cập nhật số lớp học:", error);
      }

      const scheduleBody = document.querySelector("#learning-tab-pane .schedule-body");
      scheduleBody.innerHTML = html || "<p>Không có lớp học nào.</p>";
    } catch (error) {
      console.error("Lỗi khi tải dữ liệu lịch học:", error);
      document.querySelector("#learning-tab-pane .schedule-body").innerHTML = 
        "Đã xảy ra lỗi khi tải dữ liệu.";
    }
  }

  async function loadTeachingSchedule() {
    try {
      const teacherId = localStorage.getItem("uid");
      if (!teacherId) {
        document.querySelector("#teaching-tab-pane .schedule-body").innerHTML = 
          "Không tìm thấy tài khoản của bạn.";
        return;
      }

      const q = db.collection("class").where("teacherId", "==", teacherId);
      const querySnapshot = await q.get();

      let html = "";
      let upcomingCount = 0;
      let completedCount = 0;

      for (const docSnap of querySnapshot.docs) {
        const data = docSnap.data();

        // Lấy thông tin học sinh từ collection users
        let studentName = "Không rõ";
        if (data.uid) {
          const studentDoc = await db.collection("users").doc(data.uid).get();
          if (studentDoc.exists) {
            const studentData = studentDoc.data();
            studentName = studentData.fullName || "Không rõ";
          }
        }

        // Chuyển đổi ngày và tính toán thứ
        const [year, month, day] = data.day.split('-');
        const date = new Date(Number(year), Number(month) - 1, Number(day));
        const weekdays = ['Chủ Nhật', 'Thứ Hai', 'Thứ Ba', 'Thứ Tư', 'Thứ Năm', 'Thứ Sáu', 'Thứ Bảy'];
        const weekday = weekdays[date.getDay()];

        // Xác định trạng thái dựa trên thời gian hiện tại
        const now = new Date();
        const [startHour, startMinute] = data.start.split(':');
        const [endHour, endMinute] = data.end.split(':');
        
        // Tạo đối tượng Date cho thời gian bắt đầu và kết thúc
        const startTime = new Date(date);
        startTime.setHours(parseInt(startHour), parseInt(startMinute), 0);
        
        const endTime = new Date(date);
        endTime.setHours(parseInt(endHour), parseInt(endMinute), 0);

        let status = "Sắp tới";
        let statusClass = "status-upcoming";
        
        function getDateOnly(d) {
          return new Date(d.getFullYear(), d.getMonth(), d.getDate());
        }
        const classDate = getDateOnly(date);
        const today = getDateOnly(now);

        if (classDate < today) {
          // Nếu ngày học đã qua
          status = "Kết thúc";
          statusClass = "status-completed";
          completedCount++;
        } else if (classDate.getTime() === today.getTime()) {
          // Nếu là ngày hôm nay thì kiểm tra giờ
          if (now > endTime) {
            // Nếu đã qua giờ kết thúc
            status = "Kết thúc";
            statusClass = "status-completed";
            completedCount++;
          } else if (now >= startTime && now <= endTime) {
            // Nếu đang trong giờ học
            status = "Đang diễn ra";
            statusClass = "status-ongoing";
          } else {
            // Nếu chưa đến giờ bắt đầu
            status = "Sắp tới";
            statusClass = "status-upcoming";
            upcomingCount++;
          }
        } else {
          // Nếu là ngày trong tương lai
          status = "Sắp tới";
          statusClass = "status-upcoming";
          upcomingCount++;
        }

        // Xác định đường dẫn profile dựa trên trạng thái
        const profilePath = (status === "Kết thúc") ? "/profileOther" : "/profileOthernoReview";

        html += `
          <div class="class-item">
            <div class="class-date">
              <div class="day">${weekday}</div>
              <div class="date">${data.day}</div>
            </div>
            <div class="class-info">
              <span class="status-badge ${statusClass}">${status}</span>
              <h5>${data.generalSubject || "Không có tiêu đề"}</h5>
              <p>Học sinh: ${studentName}</p>
              <p class="class-time"><i class="bi bi-clock"></i> ${data.start} - ${data.end}</p>
            </div>
            <div class="class-actions">
              <button class="action-btn">
                <i class="bi bi-info-circle"></i>
                <a href="${profilePath}?uid=${data.uid}" class="tutor-name-link"> Chi tiết học sinh </a>
              </button>
            </div>
          </div>
        `;
      }

      // Cập nhật số lớp vào Firestore
      try {
        await db.collection("users").doc(teacherId).update({
          upcomingTeachingSessions: upcomingCount,
          completedTeachingSessions: completedCount
        });
        console.log(`Cập nhật số lớp dạy - Sắp tới: ${upcomingCount}, Kết thúc: ${completedCount}`);
      } catch (error) {
        console.error("Lỗi khi cập nhật số lớp dạy:", error);
      }

      const teachingScheduleBody = document.querySelector("#teaching-tab-pane .schedule-body");
      teachingScheduleBody.innerHTML = html || "<p>Không có lớp dạy nào.</p>";
    } catch (error) {
      console.error("Lỗi khi tải dữ liệu lịch dạy:", error);
      document.querySelector("#teaching-tab-pane .schedule-body").innerHTML = 
        "Đã xảy ra lỗi khi tải dữ liệu.";
    }
  }

  function filterRequests() {
    const startTime = document.getElementById('start-time').value;
    const endTime = document.getElementById('end-time').value;
    const date = document.getElementById('date').value;
    const status = document.getElementById('status').value;
    const subject = document.getElementById('subject').value;
    const sort = document.getElementById('sort').value;
    
    const classItems = Array.from(document.querySelectorAll('.class-item'));
    
    // Filter items
    const filteredItems = classItems.filter(item => {
      let shouldShow = true;
      
      // Filter by status
      if (status) {
        const itemStatus = item.querySelector('.status-badge').textContent.toLowerCase();
        if (itemStatus !== status) {
          shouldShow = false;
        }
      }
      
      // Filter by subject
      if (subject) {
        const itemSubject = item.querySelector('h5').textContent;
        if (!itemSubject.includes(subject)) {
          shouldShow = false;
        }
      }
      
      // Filter by date
      if (date) {
        const itemDate = item.querySelector('.date').textContent;
        const [day, month, year] = itemDate.split('/');
        const itemDateObj = new Date(year, month - 1, day);
        const filterDate = new Date(date);
        if (itemDateObj.toDateString() !== filterDate.toDateString()) {
          shouldShow = false;
        }
      }
      
      // Filter by time
      if (startTime || endTime) {
        const timeText = item.querySelector('.class-time').textContent;
        const timeMatch = timeText.match(/(\d{2}:\d{2}) - (\d{2}:\d{2})/);
        if (timeMatch) {
          const [_, itemStart, itemEnd] = timeMatch;
          
          if (startTime && itemStart < startTime) {
            shouldShow = false;
          }
          
          if (endTime && itemEnd > endTime) {
            shouldShow = false;
          }
        }
      }
      
      return shouldShow;
    });

    // Sort items
    filteredItems.sort((a, b) => {
      switch(sort) {
        case 'date-asc':
          return new Date(a.querySelector('.date').textContent) - new Date(b.querySelector('.date').textContent);
        case 'date-desc':
          return new Date(b.querySelector('.date').textContent) - new Date(a.querySelector('.date').textContent);
        case 'time-asc':
          return a.querySelector('.class-time').textContent.localeCompare(b.querySelector('.class-time').textContent);
        case 'time-desc':
          return b.querySelector('.class-time').textContent.localeCompare(a.querySelector('.class-time').textContent);
        case 'subject-asc':
          return a.querySelector('h5').textContent.localeCompare(b.querySelector('h5').textContent);
        case 'subject-desc':
          return b.querySelector('h5').textContent.localeCompare(a.querySelector('h5').textContent);
        default:
          return 0;
      }
    });

    // Get the container
    const container = document.querySelector('.schedule-body');
    
    // Remove all items
    classItems.forEach(item => {
      item.style.opacity = '0';
      item.style.transform = 'translateY(-10px)';
      setTimeout(() => {
        item.style.display = 'none';
      }, 300);
    });

    // Add filtered and sorted items back
    setTimeout(() => {
      filteredItems.forEach((item, index) => {
        item.style.display = 'block';
        setTimeout(() => {
          item.style.opacity = '1';
          item.style.transform = 'translateY(0)';
        }, index * 50);
      });
    }, 300);
  }
  </script>
</body>

</html>