<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Tìm Kiếm Request - HlearnHub</title>
  <meta name="description" content="HlearnHub student learning platform">
  <meta name="keywords" content="education, tutoring, online learning">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&family=Poppins:wght@100;200;300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <link href="assets/css/main.css" rel="stylesheet">

  <style>
    :root {
      --primary-color: #AA261B;
      --secondary-color: #AA261B;
      --accent-color: #AA261B;
      --light-color: #fff;
      --dark-color: #34495e;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
    }
    
    body {
      font-family: 'Open Sans', sans-serif;
      color: #444;
      background-color: #d7d5d5c4;
    } 
    
    h1, h2, h3, h4, h5, h6 {
      font-family: var(--heading-font);
      color: #fff;
      font-weight: 600;
    }

    /* Page Title Styles */
    .page-title {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 60px 0;
      margin-bottom: 40px;
    }

    .page-title h1 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      color: white;
    }

    .page-title .lead {
      font-size: 1.2rem;
      opacity: 0.9;
    }

    /* Filter Section */
    .filter-section {
      background: white;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      padding: 30px;
      margin-bottom: 30px;
    }

    .filter-section h3 {
      color: var(--primary-color);
      margin-bottom: 25px;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
    }

    .form-label {
      color: var(--primary-color);
      font-weight: 600;
      margin-bottom: 8px;
    }

    .form-control,
    .form-select {
      border: 2px solid #e9ecef;
      border-radius: 10px;
      padding: 12px 15px;
      transition: all 0.3s;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(170, 38, 27, 0.15);
    }

    .btn-search {
      background: var(--primary-color);
      border: none;
      color: white;
      padding: 12px 30px;
      border-radius: 25px;
      font-weight: 600;
      transition: all 0.3s;
      width: 100%;
      margin-top: 20px;
    }

    .btn-search:hover {
      background: #8a1e15;
      transform: translateY(-2px);
    }

    /* Request List Section */
    .request-list-section {
      background: white;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .section-header {
      background: var(--primary-color);
      padding: 20px 30px;
    }

    .section-header h3 {
      color: white;
      margin: 0;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
    }

    .request-list {
      padding: 20px;
      max-height: 700px;
      overflow-y: auto;
    }

    /* Custom Scrollbar */
    .request-list::-webkit-scrollbar {
      width: 8px;
    }

    .request-list::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    .request-list::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
      transition: all 0.3s;
    }

    .request-list::-webkit-scrollbar-thumb:hover {
      background: #8a1e15;
    }

    .request-item {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      border-left: 5px solid var(--primary-color);
      transition: all 0.3s;
      cursor: pointer;
    }

    .request-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      background: white;
    }

    .request-item:last-child {
      margin-bottom: 0;
    }

    .student-name {
      color: var(--primary-color);
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }

    .student-name i {
      margin-right: 10px;
      font-size: 1.2rem;
    }

    .request-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    .detail-item {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #666;
      font-size: 15px;
    }

    .detail-item i {
      color: var(--primary-color);
      font-size: 18px;
      width: 20px;
      text-align: center;
    }

    .detail-item strong {
      color: #333;
      font-weight: 600;
    }

    .detail-value {
      color: #555;
      font-weight: 500;
    }

    /* Action Button */
    .action-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 25px;
      border-radius: 20px;
      font-weight: 600;
      margin-top: 15px;
      transition: all 0.3s;
      cursor: pointer;
    }

    .action-btn:hover {
      background: #8a1e15;
      transform: translateY(-2px);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .navmenu ul {
        flex-direction: column;
        gap: 10px;
      }

      .page-title h1 {
        font-size: 2rem;
      }

      .filter-section {
        padding: 20px;
        margin-bottom: 20px;
      }

      .request-details {
        grid-template-columns: 1fr;
      }

      .student-name {
        font-size: 1.2rem;
      }

      .request-list {
        max-height: 500px;
      }
    }

    .page-title {
      margin-bottom: 30px;
    }

    .container {
      margin-bottom: 90px; /* Thêm khoảng cách với footer */
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header id="header" class="header d-flex align-items-center sticky-top">
    <div class="container-fluid container-xl position-relative d-flex align-items-center">
      <a href="/" class="logo d-flex align-items-center me-auto">
        <h1 class="sitename">HlearnHub</h1>
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="/">Trang chủ</a></li>
          <li><a href="/about">Về chúng tôi</a></li>
          <li><a href="/dayvaHoc">Dạy và học</a></li>
          <li><a href="/schedule">Lịch cá nhân</a></li>
        </ul>
      </nav>
      <a class="btn-getstarted" href="/profile"><i class="bi bi-person-circle me-2"></i><span id="user-nickname"></span></a>
    </div>
  </header>

  <main class="main">
    <!-- Page Title Section -->
    <div class="page-title">
      <div class="container">
        <div class="row d-flex justify-content-center text-center">
          <div class="col-lg-8">
            <h1>Đăng ký dạy</h1>
            <p class="lead"></p> <!--Không biết viết gì-->
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="container">
      <!-- Filter Section -->
      <div class="filter-section">
        <h3><i class="bi bi-funnel-fill me-2"></i>Bộ Lọc Tìm Kiếm</h3>
        <div class="row">
          <div class="col-md-3 mb-3">
            <label for="start-time" class="form-label">Giờ bắt đầu</label>
            <input type="time" class="form-control" id="start-time">
          </div>
          <div class="col-md-3 mb-3">
            <label for="end-time" class="form-label">Giờ kết thúc</label>
            <input type="time" class="form-control" id="end-time">
          </div>
          <div class="col-md-3 mb-3">
            <label for="date" class="form-label">Ngày</label>
            <input type="date" class="form-control" id="date">
          </div>
          <div class="col-md-3 mb-3">
            <label for="subject" class="form-label">Môn học</label>
            <select class="form-select" id="subject">
              <option value="">Tất cả môn học</option>
              <option value="Calculus 1">Giải tích I</option>
              <option value="Calculus 2">Giải tích II</option>
              <option value="Calculus 3">Giải tích III</option>
              <option value="Probability and Statistics">Xác suất thống kê</option>
              <option value="linear Algebra">Đại số tuyến tính</option>
              <option value="Physics">Vật lý đại cương</option>
              <option value="Chemistry">Hóa học đại cương</option>
              <option value="English">Tiếng Anh cơ bản</option>
              <option value="Philosophy">Triết học Mác-Lênin</option>
              <option value="Economics">Kinh tế chính trị</option>
            </select>
          </div>
          <div class="col-12">
            <button class="btn btn-search" onclick="filterRequests()">
              <i class="bi bi-search me-2"></i>Tìm Kiếm
            </button>
          </div>
        </div>
      </div>

      <!-- Request List Section -->
      <div class="request-list-section">
        <div class="section-header">
          <h3><i class="bi bi-list-ul me-2"></i>Danh Sách Request</h3>
        </div>
        <div style="padding: 10px 30px 0 30px; font-size: 0.95rem; color: #888;">
          (Chỉ hiển thị những lớp từ 24 tiếng trở đi)
        </div>
        <div class="request-list" id="request-list">
          <template id="request-item-template">
            <div class="request-item" 
                data-subject="" 
                data-time="" 
                data-date="">
              <div class="student-name">
                <i class="bi bi-person-fill"></i>
                <span class="student-fullname"></span>
              </div>
              <div class="request-details">
                <div class="detail-item">
                  <i class="bi bi-book-fill"></i>
                  <span><strong>Môn học:</strong> <span class="detail-value subject-name"></span></span>
                </div>
                <div class="detail-item">
                  <i class="bi bi-clock-fill"></i>
                  <span><strong>Giờ bắt đầu:</strong> <span class="detail-value start-time"></span></span>
                </div>
                <div class="detail-item">
                  <i class="bi bi-clock"></i>
                  <span><strong>Giờ kết thúc:</strong> <span class="detail-value end-time"></span></span>
                </div>
                <div class="detail-item">
                  <i class="bi bi-calendar3"></i>
                  <span><strong>Ngày học:</strong> <span class="detail-value study-day"></span></span>
                </div>
                <div class="detail-item">
                  <i class="bi bi-chat-left-text"></i>
                  <span><strong>Ghi chú:</strong> <span class="detail-value note"></span></span>
                </div>
              </div>
              <button class="action-btn">
                <i class="bi bi-hand-thumbs-up me-2"></i>Ứng Tuyển
              </button>
            </div>
          </template>
        </div>
      </div>
    </div>
  </main>

  <footer id="footer" class="footer">
    <div class="container footer-top">
      <div class="row gy-4">
        <div class="col-lg-5 col-md-12 footer-info">
          <div class="footer-logo">Hlearn<span>Hub</span></div>
          <p class="footer-subtitle">Giải pháp tìm kiếm gia sư trực tiếp dành riêng cho sinh viên HUST</p>
          <div class="social-links d-flex mt-4">
            <a href="#"><i class="bi bi-twitter-x"></i></a>
            <a href="#"><i class="bi bi-facebook"></i></a>
            <a href="#"><i class="bi bi-instagram"></i></a>
            <a href="#"><i class="bi bi-linkedin"></i></a>
          </div>
        </div>
        
        <div class="col-lg-7 col-md-12">
          <div class="row">
            <div class="col-lg-4 col-6 footer-links">
              <div class="footer-contact">
                <p><i class="bi bi-geo-alt me-2"></i> Số 1 Đại Cồ Việt, Hai Bà Trưng, Hà Nội</p>
                <p><i class="bi bi-telephone me-2"></i> +84 123 456 789</p>
                <p><i class="bi bi-envelope me-2"></i> info@hlearnhub.com</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="container copyright text-center mt-4">
      <p>&copy; <span>2025</span> <strong>HlearnHub</strong>. All Rights Reserved</p>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase -->
   <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>

  <!-- Bootstrap JS (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAWXMEwMPSyMBVf4LikdsVCZ0kN4BhYB6E",
      authDomain: "hlearnhub-testing.firebaseapp.com",
      projectId: "hlearnhub-testing",
      messagingSenderId: "1054297107041",
      appId: "1:1054297107041:web:e2e985461b9ac570441820"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // Lấy fullName từ uid
    async function getUserFullName(uid) {
      const userDoc = await db.collection('users').doc(uid).get();
      if (userDoc.exists) {
        return userDoc.data().fullName || 'Không rõ tên';
      }
      return 'Không rõ tên';
    }

    function renderRequestsRealtime() {
      const requestList = document.getElementById('request-list');
      const template = document.getElementById('request-item-template');
      requestList.innerHTML = '<div>Đang tải dữ liệu...</div>';

      db.collection('studyingRequest').onSnapshot(async (snapshot) => {
        if (snapshot.empty) {
          requestList.innerHTML = '<div>Không có request nào.</div>';
          return;
        }
        requestList.innerHTML = '';
        const requests = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          data.id = doc.id;
          requests.push(data);
        });

        const currentUid = localStorage.getItem("uid"); // Lấy UID của người dùng hiện tại

        for (const req of requests) {
          // Kiểm tra thời gian bắt đầu còn ít nhất 24 tiếng
          const studyDate = req.day; // yyyy-mm-dd
          const startTime = req.start; // hh:mm
          if (!studyDate || !startTime) continue;
          const startDateTime = new Date(`${studyDate}T${startTime}`);
          const now = new Date();
          if (startDateTime - now < 86400000) {
            // Nếu còn dưới 24 tiếng thì bỏ qua không hiển thị
            continue;
          }

          const fullName = await getUserFullName(req.uid);
          const clone = template.content.cloneNode(true);
          const item = clone.querySelector('.request-item');
          item.dataset.subject = req.generalSubject || '';
          item.dataset.time = `${req.start || ''}-${req.end || ''}`;
          item.dataset.date = req.day || '';
          clone.querySelector('.student-fullname').textContent = fullName;
          clone.querySelector('.subject-name').textContent = req.generalSubject || '';
          clone.querySelector('.start-time').textContent = req.start || '';
          clone.querySelector('.end-time').textContent = req.end || '';
          clone.querySelector('.study-day').textContent = req.day || '';
          clone.querySelector('.note').textContent = req.note || '';

          // Kiểm tra nếu request do người dùng hiện tại tạo ra
          const actionBtn = clone.querySelector('.action-btn');
          if (req.uid === currentUid) {
            actionBtn.innerHTML = '<i class="bi bi-x-circle me-2"></i>Không thể ứng tuyển';
            actionBtn.style.background = '#ccc';
            actionBtn.style.cursor = 'not-allowed';
            actionBtn.disabled = true;
          } else {
            // Gán sự kiện cho nút ứng tuyển
            actionBtn.addEventListener('click', async function (e) {
              e.stopPropagation();
              const currentUid = localStorage.getItem("uid"); // Lấy UID của người dùng hiện tại
              if (!currentUid) {
                alert("Không tìm thấy UID người dùng.");
                return;
              }

              try {
                // Kiểm tra xem UID đã tồn tại trong subcollection "uids" chưa
                const uidsSnapshot = await db.collection('studyingRequest')
                  .doc(req.id) // ID của tài liệu request
                  .collection('uids')
                  .where('uid', '==', currentUid)
                  .get();

                if (!uidsSnapshot.empty) {
                  alert("Bạn đã ứng tuyển cho request này, không thể ứng tuyển lại");
                  return;
                }

                // Lấy fullName của người dùng từ collection "users"
                const userDoc = await db.collection('users').doc(currentUid).get();
                if (!userDoc.exists) {
                  alert("Không tìm thấy thông tin người dùng.");
                  return;
                }
                const fullName = userDoc.data().fullName || "Không rõ tên";

                // Lưu UID và fullName vào subcollection "uids" trong tài liệu hiện tại
                await db.collection('studyingRequest')
                  .doc(req.id) // ID của tài liệu request
                  .collection('uids')
                  .add({ uid: currentUid, fullName: fullName });

                // Cập nhật giao diện nút
                this.innerHTML = '<i class="bi bi-check-circle me-2"></i>Đã Ứng Tuyển';
                this.style.background = '#2ecc71';
                this.disabled = true;

                alert("Ứng tuyển thành công!");
              } catch (error) {
                console.error("Lỗi khi lưu UID vào Firestore:", error);
                alert("Đã xảy ra lỗi khi ứng tuyển. Vui lòng thử lại.");
              }
            });
          }

          requestList.appendChild(clone);
        }
      });
    }

    function filterRequests() {
      const startTime = document.getElementById('start-time').value;
      const endTime = document.getElementById('end-time').value;
      const date = document.getElementById('date').value;
      const subject = document.getElementById('subject').value;
      
      const requestItems = document.querySelectorAll('.request-item');
      
      requestItems.forEach(item => {
        let shouldShow = true;
        
        // Filter by subject
        if (subject && !item.dataset.subject.includes(subject)) {
          shouldShow = false;
        }
        
        // Filter by date
        if (date) {
          const itemDate = new Date(item.dataset.date);
          const filterDate = new Date(date);
          if (itemDate.toDateString() !== filterDate.toDateString()) {
            shouldShow = false;
          }
        }
        
        // Filter by time (basic implementation)
        if (startTime || endTime) {
          const itemTime = item.dataset.time;
          const [itemStart, itemEnd] = itemTime.split('-');
          
          if (startTime && itemStart < startTime) {
            shouldShow = false;
          }
          
          if (endTime && itemEnd > endTime) {
            shouldShow = false;
          }
        }
        
        // Show/hide item
        if (shouldShow) {
          item.style.display = 'block';
          setTimeout(() => {
            item.style.opacity = '1';
            item.style.transform = 'translateY(0)';
          }, 50);
        } else {
          item.style.opacity = '0';
          item.style.transform = 'translateY(-10px)';
          setTimeout(() => {
            item.style.display = 'none';
          }, 300);
        }
      });
    }

    // Add click event to action buttons
    // document.addEventListener('DOMContentLoaded', function() {
    //   const actionButtons = document.querySelectorAll('.action-btn');
      
    //   actionButtons.forEach(button => {
    //     button.addEventListener('click', function(e) {
    //       e.stopPropagation();
    //       this.innerHTML = '<i class="bi bi-check-circle me-2"></i>Đã Ứng Tuyển';
    //       this.style.background = '#2ecc71';
    //       this.disabled = true;
    //     });
    //   });

    //   // Add click event to request items for more details
    //   const requestItems = document.querySelectorAll('.request-item');
      
    //   requestItems.forEach(item => {
    //     item.addEventListener('click', function() {
    //       // You can add functionality to show more details or navigate to detail page
    //       console.log('Request item clicked');
    //     });
    //   });
      
    //   console.log('Tutoring Search Page Loaded');
    // });

    document.addEventListener("DOMContentLoaded", async () => {
      const uid = localStorage.getItem("uid");
      if (!uid) {
        alert("Không tìm thấy uid");
        return;
      }

      try {
        const doc = await db.collection("users").doc(uid).get(); 
        if (!doc.exists) {
          alert("Không tìm thấy dữ liệu người dùng.");
          return;
        }
        const userData = doc.data();
        document.getElementById('user-nickname').textContent = userData.fullName || "Không có tên";
      } catch (err) {
        console.error("Lỗi khi lấy dữ liệu người dùng:", err);
        alert("Lỗi khi lấy dữ liệu người dùng: " + err.message);
      }

      renderRequestsRealtime();
    });

    // document.addEventListener('DOMContentLoaded', function() {
    //   renderRequestsRealtime();
    // });
  </script>
</body>

</html>