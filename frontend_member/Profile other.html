<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>HlearnHub - Thông tin cá nhân</title>
  <meta name="description" content="HlearnHub student learning platform">
  <meta name="keywords" content="education, tutoring, online learning">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&family=Poppins:wght@100;200;300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <link href="assets/css/main.css" rel="stylesheet">
  
  <style>
    :root {
      --primary-color: #AA261B;
      --secondary-color: #F8B195;
      --accent-color: #AA261B;
      --light-color: #fff;
      --dark-color: #34495e;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --bg-color: #f8f9fa;
      --border-radius: 15px;
    }
    
    body {
      font-family: 'Open Sans', sans-serif;
      color: #444;
      background-color: #f0f2f5;
      line-height: 1.6;
    } 
    
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Poppins', sans-serif;
      color: #333;
      font-weight: 600;
    }

    /* Header Styles */

    /* Personal Info Page Styles */
    .main {
      padding: 60px 0;
    }
    
    .profile-section {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
      padding: 40px;
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
    }
    
    .profile-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 8px;
      background: var(--primary-color);
    }
    
    .profile-header {
      border-bottom: 1px solid #eee;
      padding-bottom: 30px;
      margin-bottom: 30px;
    }
    
    .profile-header h2 {
      color: var(--primary-color);
      font-weight: 700;
      margin-bottom: 30px;
      text-align: center;
      font-family: 'Poppins', sans-serif;
      position: relative;
      padding-bottom: 15px;
    }
    
    .profile-header h2::after {
      content: '';
      position: absolute;
      width: 60px;
      height: 3px;
      background: var(--primary-color);
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
    }
    
    .profile-image-container {
      position: relative;
      display: flex;
      justify-content: center;
    }
    
    .profile-image {
      width: 240px;
      height: 320px;
      border-radius: 12px;
      background-color: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      object-fit: cover;
      border: 5px solid white;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      transition: transform 0.3s ease;
    }
    
    .profile-image:hover {
      transform: scale(1.02);
    }
    
    .info-item {
      display: flex;
      margin-bottom: 18px;
      align-items: center;
    }
    
    .info-label {
      min-width: 140px;
      font-weight: 600;
      font-size: 16px;
      color: var(--primary-color);
      position: relative;
      padding-left: 25px;
    }
    
    .info-label::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      background-color: var(--primary-color);
      border-radius: 50%;
    }
    
    .info-value {
      font-size: 16px;
      font-weight: 500;
    }
    
    .profile-basic-info {
      background-color: #f9f9f9;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 20px;
      border-left: 4px solid var(--primary-color);
    }
    
    .stats-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin: 25px 0;
    }
    
    .stat-item {
      background-color: white;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      transition: transform 0.3s ease;
    }
    
    .stat-item:hover {
      transform: translateY(-5px);
    }
    
    .stat-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .stat-value {
      font-size: 22px;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .rating-container {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 3px 15px rgba(0,0,0,0.08);
      margin-top: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .rating {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .stars {
      font-size: 22px;
      color: #ffc107;
      margin-right: 15px;
    }
    
    .rating-number {
      font-size: 20px;
      font-weight: 700;
      color: #333;
    }

    .rating-text {
      font-size: 14px;
      color: #666;
      margin-left: 15px;
    }
    
    .student-reviews {
      margin-top: 40px;
    }
    
    .student-reviews h3 {
      color: var(--primary-color);
      margin-bottom: 25px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
      position: relative;
    }
    
    .student-reviews h3::after {
      content: '';
      position: absolute;
      width: 50px;
      height: 3px;
      background: var(--primary-color);
      bottom: -1px;
      left: 0;
    }
    
    .reviews-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .reviews-title {
      color: var(--primary-color);
      margin: 0;
      position: relative;
    }
    
    .reviews-title::after {
      content: '';
      position: absolute;
      width: 50px;
      height: 3px;
      background: var(--primary-color);
      bottom: -10px;
      left: 0;
    }
    
    .review-item {
      margin-bottom: 20px;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 12px;
      border-left: 4px solid var(--primary-color);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .review-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.08);
    }
    
    .review-text {
      font-style: italic;
      position: relative;
      padding-left: 25px;
    }
    
    .review-text::before {
      content: '"';
      font-size: 40px;
      position: absolute;
      left: 0;
      top: -15px;
      color: #ccc;
      font-family: Georgia, serif;
    }
    
    .review-author {
      font-weight: 600;
      color: #666 !important;
    }
    
    /* Edit button styles */
    .edit-btn {
      color: #AA261B;
      border-color: #AA261B;
      transition: all 0.3s ease;
    }
    
    .edit-btn:hover {
      background-color: #AA261B;
      color: white;
    }
    
    .edit-icon {
      color: #AA261B;
      opacity: 0.7;
      transition: all 0.3s ease;
    }
    
    .edit-icon:hover {
      opacity: 1;
      transform: scale(1.1);
    }
    
    .camera-edit-btn {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background-color: rgba(255,255,255,0.8);
      border-radius: 50%;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      border: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .camera-edit-btn:hover {
      background-color: #AA261B;
    }
    
    .camera-edit-btn:hover i {
      color: white !important;
    }
    
    .account-settings .card {
      transition: all 0.3s ease;
      border: none;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .account-settings .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.12);
    }
    
    /* Footer Styles */
    /* Responsive */
    @media (max-width: 991px) {
      .profile-header {
        text-align: center;
      }
      
      .profile-image {
        margin: 0 auto 20px;
      }
      
      .footer-contact {
        text-align: left;
        margin-top: 30px;
      }
      
      .stats-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .profile-section {
        padding: 25px;
      }
      
      .stats-container {
        grid-template-columns: 1fr;
      }
      
      .rating-container {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .rating {
        margin-bottom: 15px;
      }
      
      .reviews-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .rating-container {
        margin-top: 15px;
        align-self: stretch;
      }
    }

    /* Review Form Styles */
    .review-form-container {
      background-color: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 3px 15px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }

    .review-form-container h4 {
      color: var(--primary-color);
      font-weight: 600;
      margin-bottom: 20px;
    }

    .role-selection {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }

    .form-check-input:checked {
      background-color: #AA261B;
      border-color: #AA261B;
    }

    .star-rating {
      font-size: 24px;
      color: #ffc107;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .star-container {
      position: relative;
      width: 24px;
      height: 24px;
      margin-right: 5px;
    }

    .star-half, .star-full {
      position: absolute;
      top: 0;
      left: 0;
      transition: transform 0.2s ease;
    }

    .star-half {
      clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%);
    }

    .star-full {
      clip-path: polygon(50% 0, 100% 0, 100% 100%, 50% 100%);
    }

    .star-container:hover .star-half,
    .star-container:hover .star-full {
      transform: scale(1.2);
    }

    .star-container.active .star-half,
    .star-container.active .star-full {
      color: #ffc107;
    }

    .rating-value {
      font-size: 16px;
      color: #666;
      font-weight: 500;
    }

    #currentRating {
      color: #AA261B;
      font-weight: 600;
    }

    .form-control:focus {
      border-color: #AA261B;
      box-shadow: 0 0 0 0.2rem rgba(170, 38, 27, 0.25);
    }

    .btn-primary:hover {
      background-color: #8a1f17 !important;
      border-color: #8a1f17 !important;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header id="header" class="header d-flex align-items-center sticky-top">
    <div class="container-fluid container-xl position-relative d-flex align-items-center">
      <a href="/" class="logo d-flex align-items-center me-auto">
        <h1 class="sitename">HlearnHub</h1>
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="/" >Trang chủ</a></li>
          <li><a href="/about">Về chúng tôi</a></li>
          <li><a href="/dayVaHoc">Dạy và học</a></li>
          <li><a href="/schedule">Lịch cá nhân</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>

      <a class="btn-getstarted" href="/profile"><i class="bi bi-person-circle me-2"></i><span id="user-nickname"></span></a>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main py-5">
    <div class="container">
      <div class="profile-section">
        <div class="profile-header">
          <h2 class="d-flex justify-content-center align-items-center">
            Thông tin cá nhân User
          </h2>
          <div class="row align-items-center">
            <div class="col-12">
              <div class="profile-basic-info">
                <div class="info-item">
                  <div class="info-label">Họ và tên:</div>
                  <div class="info-value d-flex align-items-center">
                    <span id="user-name"></span> 
                  </div>
                </div>
                <div class="info-item">
                  <div class="info-label">Ngày sinh:</div> 
                  <div class="info-value d-flex align-items-center">
                    <span id="user-birthday"></span>
                  </div>
                </div>
                <div class="info-item">
                  <div class="info-label">Ngành học:</div>
                  <div class="info-value d-flex align-items-center">
                    <span id="user-major"></span>
                  </div>
                </div>
                <div class="info-item">
                  <div class="info-label">Khóa:</div>
                  <div class="info-value d-flex align-items-center">
                    <span id="user-course"></span>
                  </div>
                </div>
                <div class="info-item">
                  <div class="info-label">Số điện thoại:</div>
                  <div class="info-value d-flex align-items-center">
                    <span id="user-sdt"></span>
                  </div>
                </div>
              </div>
              
              <div class="stats-container">
                <div class="stat-item">
                  <div class="stat-label">GPA</div>
                  <div class="stat-value"><span id="user-gpa"></span></div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">CPA</div>
                  <div class="stat-value"><span id="user-cpa"></span></div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">Lớp đã học</div>
                  <div class="stat-value"><span id="user-completedStudy"></span></div> 
                </div>
                <div class="stat-item">
                  <div class="stat-label">Lớp đã dạy</div>
                  <div class="stat-value"><span id="user-completedTeach"></span></div> 
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="student-reviews">
          <div class="reviews-header">
            <h3 class="reviews-title">
              <i class="bi bi-chat-quote me-2"></i>Đánh giá
            </h3>
            <div class="rating-container">
              <div class="rating">
                <div class="stars" id="average-stars">
                  <!-- Stars will be dynamically inserted here -->
                </div>
                <span class="rating-number" id="average-rating">0.0/5</span>
                <i class="bi bi-star-fill ms-1" style="color: #ffc107;"></i>
              </div>
              <div class="rating-text">
                <span id="total-reviews">0</span> đánh giá
              </div>
            </div>
          </div>

          <!-- Form đánh giá mới -->
          <div class="review-form-container mb-4">
            <h4 class="mb-3">Viết đánh giá của bạn</h4>
            <form id="reviewForm" class="review-form">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Vai trò của bạn</label>
                  <div class="role-selection">
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="role" id="studentRole" value="student" checked>
                      <label class="form-check-label" for="studentRole">Học sinh</label>
                    </div>
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="role" id="tutorRole" value="tutor">
                      <label class="form-check-label" for="tutorRole">Gia sư</label>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Đánh giá của bạn</label>
                  <div class="star-rating">
                    <div class="star-container" data-rating="1">
                      <i class="bi bi-star-half star-half"></i>
                      <i class="bi bi-star star-full"></i>
                    </div>
                    <div class="star-container" data-rating="2">
                      <i class="bi bi-star-half star-half"></i>
                      <i class="bi bi-star star-full"></i>
                    </div>
                    <div class="star-container" data-rating="3">
                      <i class="bi bi-star-half star-half"></i>
                      <i class="bi bi-star star-full"></i>
                    </div>
                    <div class="star-container" data-rating="4">
                      <i class="bi bi-star-half star-half"></i>
                      <i class="bi bi-star star-full"></i>
                    </div>
                    <div class="star-container" data-rating="5">
                      <i class="bi bi-star-half star-half"></i>
                      <i class="bi bi-star star-full"></i>
                    </div>
                  </div>
                  <div class="rating-value mt-2">
                    <span id="currentRating">0</span>/5
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label for="reviewText" class="form-label">Nội dung đánh giá</label>
                <textarea class="form-control" id="reviewText" rows="4" placeholder="Viết đánh giá của bạn ở đây..."></textarea>
              </div>
              <button type="submit" class="btn btn-primary" style="background-color: #AA261B; border-color: #AA261B;">
                <i class="bi bi-send me-2"></i>Gửi đánh giá
              </button>
            </form>
          </div>

          <!-- Danh sách đánh giá sẽ được chèn vào đây -->
          <div class="reviews-list"></div>
        </div>
      </div>
    </div>
  </main>

  <footer id="footer" class="footer">
    <div class="container footer-top">
      <div class="row gy-4">
        <div class="col-lg-5 col-md-12 footer-info">
          <div class="footer-logo">Hlearn<span>Hub</span></div>
          <p class="footer-subtitle">HlearnHub – Học cùng nhau, vững bước cùng nhau.</p>
          <div class="social-links d-flex mt-4">
            <a href="#"><i class="bi bi-twitter-x"></i></a>
            <a href="#"><i class="bi bi-facebook"></i></a>
            <a href="#"><i class="bi bi-instagram"></i></a>
            <a href="#"><i class="bi bi-linkedin"></i></a>
          </div>
        </div>
        
        <div class="col-lg-7 col-md-12">
          <div class="footer-contact text-end">
            <p><i class="bi bi-geo-alt me-2"></i> 285 Đội Cấn, Ba Đình, Hà Nội</p>
            <p><i class="bi bi-telephone me-2"></i> +84 123 456 789</p>
            <p><i class="bi bi-envelope me-2"></i> info@hlearnhub.com</p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="container copyright text-center mt-4">
      <p>&copy; <span>2025</span> <strong>HlearnHub</strong>. All Rights Reserved</p>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
      });
    });
  </script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp, setDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAWXMEwMPSyMBVf4LikdsVCZ0kN4BhYB6E",
      authDomain: "hlearnhub-testing.firebaseapp.com",
      projectId: "hlearnhub-testing",
      messagingSenderId: "1054297107041",
      appId: "1:1054297107041:web:e2e985461b9ac570441820"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Lấy và hiển thị tên người dùng hiện tại
    document.addEventListener('DOMContentLoaded', async () => {
      const uid = localStorage.getItem("uid");
      if (uid) {
        try {
          const userRef = doc(db, "users", uid);
          const userSnap = await getDoc(userRef);
          if (userSnap.exists()) {
            const userData = userSnap.data();
            document.getElementById('user-nickname').textContent = userData.fullName || "Không có tên";
          }
        } catch (err) {
          console.error("Lỗi khi lấy dữ liệu người dùng:", err);
        }
      }
    });

    // Lấy UID từ URL
    const params = new URLSearchParams(window.location.search);
    const uid = params.get("uid");

    if (!uid) { //trường hợp không tìm thấy uid
      alert("Không tìm thấy UID trong URL");
    } else {
      loadUser(uid);
    }

    async function loadUser(uid) { 
      try {
        const userDoc = await getDoc(doc(db, "users", uid));
        if (userDoc.exists()) {
          const data = userDoc.data(); // lấy các thông tin từ document
          document.getElementById('user-name').textContent = data.fullName || "Không có tên";
          document.getElementById('user-birthday').textContent = data.birthDate || "Không có ngày sinh";
          document.getElementById('user-major').textContent = data.departmentCode || "Không có ngành học";
          document.getElementById('user-course').textContent = data.course || "Không có khóa học";
          document.getElementById('user-gpa').textContent = data.recentGPA || "0";
          document.getElementById('user-cpa').textContent = data.cpa || "0";
          document.getElementById('user-completedStudy').textContent = data.completedStudySessions || "0";
          document.getElementById('user-completedTeach').textContent = data.completedTeachingSessions || "0";
          document.getElementById('user-sdt').textContent = data.phoneNumber || "0";

          // Load reviews after loading user data
          await loadReviews(uid); // tạm hoãn hàm loadReviews cho đến khi dữ liệu người dùng được tải xong
        } else {
          document.getElementById("user-name").textContent = "Không tìm thấy người dùng.";
        }
      } catch (error) { // bắt lỗi
        console.error("Lỗi khi tải dữ liệu:", error);
        alert("Đã xảy ra lỗi khi tải dữ liệu: " + error.message);
      }
    }

    async function loadReviews(uid) {
      try {
        const reviewsList = document.querySelector('.reviews-list');
        if (!reviewsList) {
          console.error("Không tìm thấy phần tử reviews-list");
          return;
        }

        // Lấy tất cả đánh giá từ subcollection reviews
        const reviewsQuery = query(collection(db, "users", uid, "reviews"), orderBy("createdAt", "desc"));
        //truy vấn review và sắp xếp theo thứ tự thời gian
        const reviewsSnapshot = await getDocs(reviewsQuery);

        let averageRating = 0;
        let totalRating = 0;

        if (reviewsSnapshot.empty) {
          reviewsList.innerHTML = '<p class="text-center text-muted">Chưa có đánh giá nào.</p>';
          // Cập nhật Star field thành 0 nếu không có review
          await setDoc(doc(db, "users", uid), { Star: 0 }, { merge: true });
        } else {
          let reviewsHTML = '';

          for (const reviewDoc of reviewsSnapshot.docs) {
            const review = reviewDoc.data();
            
            try {
              // Lấy thông tin người đánh giá
              const reviewerDoc = await getDoc(doc(db, "users", review.reviewerId));
              const reviewerData = reviewerDoc.exists() ? reviewerDoc.data() : { fullName: 'Người dùng không xác định' };
              
              // Tính toán số sao
              totalRating += review.rating;
              const fullStars = Math.floor(review.rating);
              const hasHalfStar = review.rating % 1 !== 0;

              // Tạo HTML cho sao
              let starsHTML = '';
              for (let i = 1; i <= 5; i++) {
                if (i <= fullStars) {
                  starsHTML += '<i class="bi bi-star-fill"></i>';
                } else if (i === fullStars + 1 && hasHalfStar) {
                  starsHTML += '<i class="bi bi-star-half"></i>';
                } else {
                  starsHTML += '<i class="bi bi-star"></i>';
                }
              }

              // Format thời gian
              const reviewDate = review.createdAt ? new Date(review.createdAt.toDate()).toLocaleDateString('vi-VN') : 'Không có ngày';

              reviewsHTML += `
                <div class="review-item">
                  <div class="stars mb-2">
                    ${starsHTML}
                  </div>
                  <p class="review-text mb-1">${review.content}</p>
                  <div class="d-flex justify-content-between align-items-center">
                    <p class="review-author mb-0">
                      - ${reviewerData.fullName || 'Người dùng'} 
                      (${review.reviewerRole === 'student' ? 'Học sinh' : 'Gia sư'})
                    </p>
                    <small class="text-muted">${reviewDate}</small>
                  </div>
                </div>
              `;
            } catch (error) {
              console.error("Lỗi khi xử lý đánh giá:", error);
              continue; // Bỏ qua đánh giá bị lỗi và tiếp tục với đánh giá tiếp theo
            }
          }

          // Tính đánh giá trung bình
          averageRating = totalRating / reviewsSnapshot.size;
          
          // Cập nhật Star field trong document của user
          await setDoc(doc(db, "users", uid), { Star: averageRating }, { merge: true });

          // Hiển thị đánh giá trung bình
          const starsContainer = document.getElementById('average-stars');
          const ratingNumber = document.getElementById('average-rating');
          
          // Tạo HTML cho sao
          let starsHTML = '';
          const fullStars = Math.floor(averageRating);//làm tròn xuống để lấy số sao đầy
          const hasHalfStar = averageRating % 1 >= 0.5;

          for (let i = 1; i <= 5; i++) {
            if (i <= fullStars) {
              starsHTML += '<i class="bi bi-star-fill"></i>';
            } else if (i === fullStars + 1 && hasHalfStar) {
              starsHTML += '<i class="bi bi-star-half"></i>';
            } else {
              starsHTML += '<i class="bi bi-star"></i>';
            }
          } //hiển thị sao trên html

          starsContainer.innerHTML = starsHTML;
          ratingNumber.textContent = `${averageRating.toFixed(1)}/5`;
          
          // Cập nhật số lượng đánh giá
          document.getElementById('total-reviews').textContent = reviewsSnapshot.size;

          reviewsList.innerHTML = reviewsHTML;
        }
      } catch (error) {
        console.error("Lỗi khi tải đánh giá:", error);
        // Hiển thị thông báo lỗi cho người dùng
        const reviewsList = document.querySelector('.reviews-list');
        if (reviewsList) {
          reviewsList.innerHTML = `
            <div class="alert alert-danger">
              Đã xảy ra lỗi khi tải đánh giá. Vui lòng thử lại sau.
            </div>
          `;
        }
      }
    }

    // Cập nhật script cho đánh giá sao
    document.addEventListener('DOMContentLoaded', function() {
      const starContainers = document.querySelectorAll('.star-container');
      let selectedRating = 0;
      let isHalfStar = false;

      starContainers.forEach(container => {
        const rating = parseInt(container.getAttribute('data-rating'));
        
        // Xử lý hover cho nửa sao
        container.querySelector('.star-half').addEventListener('mouseover', function() {
          updateStars(rating - 0.5);
        });

        // Xử lý hover cho sao đầy
        container.querySelector('.star-full').addEventListener('mouseover', function() {
          updateStars(rating);
        });

        // Xử lý click cho nửa sao
        container.querySelector('.star-half').addEventListener('click', function() {
          selectedRating = rating - 0.5;
          isHalfStar = true;
          updateStars(selectedRating);
        });

        // Xử lý click cho sao đầy
        container.querySelector('.star-full').addEventListener('click', function() {
          selectedRating = rating;
          isHalfStar = false;
          updateStars(selectedRating);
        });
      });

      // Xử lý mouseout cho toàn bộ container
      document.querySelector('.star-rating').addEventListener('mouseout', function() {
        updateStars(selectedRating);
      });

      function updateStars(rating) {
        starContainers.forEach(container => {
          const containerRating = parseInt(container.getAttribute('data-rating'));
          const halfStar = container.querySelector('.star-half');
          const fullStar = container.querySelector('.star-full');

          if (containerRating <= Math.floor(rating)) {
            halfStar.classList.remove('bi-star-half');
            halfStar.classList.add('bi-star-fill');
            fullStar.classList.remove('bi-star');
            fullStar.classList.add('bi-star-fill');
          } else if (containerRating === Math.ceil(rating) && rating % 1 !== 0) {
            halfStar.classList.remove('bi-star');
            halfStar.classList.add('bi-star-half');
            fullStar.classList.remove('bi-star-fill');
            fullStar.classList.add('bi-star');
          } else {
            halfStar.classList.remove('bi-star-fill', 'bi-star-half');
            halfStar.classList.add('bi-star');
            fullStar.classList.remove('bi-star-fill');
            fullStar.classList.add('bi-star');
          }
        });

        // Cập nhật hiển thị giá trị đánh giá
        document.getElementById('currentRating').textContent = rating.toFixed(1);
      }

      // Xử lý form submit
      const reviewForm = document.getElementById('reviewForm');
      reviewForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const role = document.querySelector('input[name="role"]:checked').value;
        const rating = selectedRating;
        const reviewText = document.getElementById('reviewText').value;

        if (!rating) {
          alert('Vui lòng chọn số sao đánh giá');
          return;
        }

        if (!reviewText.trim()) {
          alert('Vui lòng nhập nội dung đánh giá');
          return;
        }

        try {
          const currentUser = auth.currentUser;
          if (!currentUser) {
            alert('Vui lòng đăng nhập để gửi đánh giá');
            return;
          }

          const reviewData = {
            reviewerId: currentUser.uid,
            reviewerRole: role,
            rating: rating,
            content: reviewText,
            createdAt: serverTimestamp()
          };

          await setDoc(doc(db, "users", uid, "reviews", currentUser.uid), reviewData);

          alert('Cảm ơn bạn đã gửi đánh giá!');
          
          // Reset form
          reviewForm.reset();
          selectedRating = 0;
          isHalfStar = false;
          updateStars(0);

          // Reload reviews sau khi gửi đánh giá mới
          await loadReviews(uid);
        } catch (error) {
          console.error("Lỗi khi lưu đánh giá:", error);
          alert("Đã xảy ra lỗi khi lưu đánh giá: " + error.message);
        }
      });
    });
  </script>
</body>

</html>