<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>HlearnHub - Thông tin cá nhân</title>
  <meta name="description" content="HlearnHub student learning platform">
  <meta name="keywords" content="education, tutoring, online learning">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&family=Poppins:wght@100;200;300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <link href="assets/css/main.css" rel="stylesheet">
  
  <style>
    :root {
      --primary-color: #AA261B;
      --secondary-color: #F8B195;
      --accent-color: #AA261B;
      --light-color: #fff;
      --dark-color: #34495e;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --bg-color: #f8f9fa;
      --border-radius: 15px;
    }
    
    body {
      font-family: 'Open Sans', sans-serif;
      color: #444;
      background-color: #f0f2f5;
      line-height: 1.6;
    } 
    
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Poppins', sans-serif;
      color: #333;
      font-weight: 600;
    }

    /* Header Styles */

    /* Personal Info Page Styles */
    .main {
      padding: 60px 0;
    }
    
    .profile-section {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
      padding: 40px;
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
    }
    
    .profile-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 8px;
      background: var(--primary-color);
    }
    
    .profile-header {
      border-bottom: 1px solid #eee;
      padding-bottom: 30px;
      margin-bottom: 30px;
    }
    
    .profile-header h2 {
      color: var(--primary-color);
      font-weight: 700;
      margin-bottom: 30px;
      text-align: center;
      font-family: 'Poppins', sans-serif;
      position: relative;
      padding-bottom: 15px;
    }
    
    .profile-header h2::after {
      content: '';
      position: absolute;
      width: 60px;
      height: 3px;
      background: var(--primary-color);
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
    }
    
    .profile-image-container {
      position: relative;
      display: flex;
      justify-content: center;
    }
    
    .profile-image {
      width: 240px;
      height: 320px;
      border-radius: 12px;
      background-color: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      object-fit: cover;
      border: 5px solid white;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      transition: transform 0.3s ease;
    }
    
    .profile-image:hover {
      transform: scale(1.02);
    }
    
    .info-item {
      display: flex;
      margin-bottom: 18px;
      align-items: center;
    }
    
    .info-label {
      min-width: 140px;
      font-weight: 600;
      font-size: 16px;
      color: var(--primary-color);
      position: relative;
      padding-left: 25px;
    }
    
    .info-label::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      background-color: var(--primary-color);
      border-radius: 50%;
    }
    
    .info-value {
      font-size: 16px;
      font-weight: 500;
    }
    
    .profile-basic-info {
      background-color: #f9f9f9;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 20px;
      border-left: 4px solid var(--primary-color);
    }
    
    .stats-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin: 25px 0;
    }
    
    .stat-item {
      background-color: white;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      transition: transform 0.3s ease;
    }
    
    .stat-item:hover {
      transform: translateY(-5px);
    }
    
    .stat-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .stat-value {
      font-size: 22px;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .rating-container {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 3px 15px rgba(0,0,0,0.08);
      margin-top: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .rating {
      display: flex;
      align-items: center;
    }
    
    .stars {
      font-size: 22px;
      color: #ffc107;
      margin-right: 15px;
    }
    
    .rating-number {
      font-size: 20px;
      font-weight: 700;
      color: #333;
    }
    
    .student-reviews {
      margin-top: 40px;
    }
    
    .student-reviews h3 {
      color: var(--primary-color);
      margin-bottom: 25px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
      position: relative;
    }
    
    .student-reviews h3::after {
      content: '';
      position: absolute;
      width: 50px;
      height: 3px;
      background: var(--primary-color);
      bottom: -1px;
      left: 0;
    }
    
    .reviews-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .reviews-title {
      color: var(--primary-color);
      margin: 0;
      position: relative;
    }
    
    .reviews-title::after {
      content: '';
      position: absolute;
      width: 50px;
      height: 3px;
      background: var(--primary-color);
      bottom: -10px;
      left: 0;
    }
    
    .review-item {
      margin-bottom: 20px;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 12px;
      border-left: 4px solid var(--primary-color);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .review-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.08);
    }
    
    .review-text {
      font-style: italic;
      position: relative;
      padding-left: 25px;
    }
    
    .review-text::before {
      content: '"';
      font-size: 40px;
      position: absolute;
      left: 0;
      top: -15px;
      color: #ccc;
      font-family: Georgia, serif;
    }
    
    .review-author {
      font-weight: 600;
      color: #666 !important;
    }
    
    /* Edit button styles */
    .edit-btn {
      color: #AA261B;
      border-color: #AA261B;
      transition: all 0.3s ease;
    }
    
    .edit-btn:hover {
      background-color: #AA261B;
      color: white;
    }
    
    .edit-icon {
      color: #AA261B;
      opacity: 0.7;
      transition: all 0.3s ease;
    }
    
    .edit-icon:hover {
      opacity: 1;
      transform: scale(1.1);
    }
    
    .camera-edit-btn {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background-color: rgba(255,255,255,0.8);
      border-radius: 50%;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      border: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .camera-edit-btn:hover {
      background-color: #AA261B;
    }
    
    .camera-edit-btn:hover i {
      color: white !important;
    }
    
    .account-settings .card {
      transition: all 0.3s ease;
      border: none;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .account-settings .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.12);
    }
    
    /* Footer Styles */
    /* Responsive */
    @media (max-width: 991px) {
      .profile-header {
        text-align: center;
      }
      
      .profile-image {
        margin: 0 auto 20px;
      }
      
      .footer-contact {
        text-align: left;
        margin-top: 30px;
      }
      
      .stats-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .profile-section {
        padding: 25px;
      }
      
      .stats-container {
        grid-template-columns: 1fr;
      }
      
      .rating-container {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .rating {
        margin-bottom: 15px;
      }
      
      .reviews-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .rating-container {
        margin-top: 15px;
        align-self: stretch;
      }
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header id="header" class="header d-flex align-items-center sticky-top">
    <div class="container-fluid container-xl position-relative d-flex align-items-center">
      <a href="/" class="logo d-flex align-items-center me-auto">
        <h1 class="sitename">HlearnHub</h1>
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="/" >Trang chủ</a></li>
          <li><a href="/about">Về chúng tôi</a></li>
          <li><a href="/dayVaHoc">Dạy và học</a></li>
          <li><a href="/schedule">Lịch cá nhân</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
      </nav>

      <a class="btn-getstarted" href="/profile"><i class="bi bi-person-circle me-2"></i><span id="user-nickname"></span></a>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main py-5">
    <div class="container">
      <div class="profile-section">
        <div class="profile-header">
          <h2 class="d-flex justify-content-center align-items-center">
            Thông tin cá nhân User
          </h2>
          <div class="row align-items-center">
            <div class="col-12">
              <div class="profile-basic-info">
                <div class="info-item">
                  <div class="info-label">Họ và tên:</div>
                  <div class="info-value d-flex align-items-center">
                    <span id="user-name"></span> 
                  </div>
                </div>
                <div class="info-item">
                  <div class="info-label">Ngày sinh:</div> 
                  <div class="info-value d-flex align-items-center">
                    <span id="user-birthday"></span>
                  </div>
                </div>
                <div class="info-item">
                  <div class="info-label">Ngành học:</div>
                  <div class="info-value d-flex align-items-center">
                    <span id="user-major"></span>
                  </div>
                </div>
                <div class="info-item">
                  <div class="info-label">Khóa:</div>
                  <div class="info-value d-flex align-items-center">
                    <span id="user-course"></span>
                  </div>
                </div>
                <div class="info-item">
                  <div class="info-label">Số điện thoại:</div>
                  <div class="info-value d-flex align-items-center">
                    <span id="user-sdt"></span>
                  </div>
                </div>
              </div>
              
              <div class="stats-container">
                <div class="stat-item">
                  <div class="stat-label">GPA</div>
                  <div class="stat-value"><span id="user-gpa"></span></div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">CPA</div>
                  <div class="stat-value"><span id="user-cpa"></span></div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">Lớp đã học</div>
                  <div class="stat-value"><span id="user-completedStudy"></span></div> 
                </div>
                <div class="stat-item">
                  <div class="stat-label">Lớp đã dạy</div>
                  <div class="stat-value"><span id="user-completedTeach"></span></div> 
                </div>
              </div>
              
              <div class="text-end mt-3">
                <a href="/edit" class="btn btn-outline-primary edit-btn">
                  <i class="bi bi-pencil-square me-2"></i>Chỉnh sửa thông tin 
                </a>
              </div>
            </div>
          </div>
        </div>
        
        <div class="student-reviews">
          <div class="reviews-header">
            <h3 class="reviews-title">
              <i class="bi bi-chat-quote me-2"></i>Đánh giá
            </h3>
            <div class="rating-container">
              <div class="rating">
                <div class="stars" id="average-stars">
                </div>
                <span class="rating-number" id="average-rating">0.0/5</span>
                <i class="bi bi-star-fill ms-1" style="color: #ffc107;"></i>
              </div>
            </div>
          </div>

          <!-- Reviews List -->
          <div class="reviews-list" id="reviews-list">
          </div>
        </div>
      </div>
    </div>
  </main>
  <div class="container mb-4">
    <div class="d-flex justify-content-end">
      <button id="logout-btn" style="background:#AA261B; color:white; border:none; border-radius:8px; padding:12px 28px; font-weight:600; font-size:16px;">
        <i class="bi bi-box-arrow-right me-2"></i>Đăng xuất
      </button>
    </div>
  </div>

  <footer id="footer" class="footer">
    <div class="container footer-top">
      <div class="row gy-4">
        <div class="col-lg-5 col-md-12 footer-info">
          <div class="footer-logo">Hlearn<span>Hub</span></div>
          <p class="footer-subtitle">HlearnHub – Học cùng nhau, vững bước cùng nhau.</p>
          <div class="social-links d-flex mt-4">
            <a href="#"><i class="bi bi-twitter-x"></i></a>
            <a href="#"><i class="bi bi-facebook"></i></a>
            <a href="#"><i class="bi bi-instagram"></i></a>
            <a href="#"><i class="bi bi-linkedin"></i></a>
          </div>
        </div>
        
        <div class="col-lg-7 col-md-12">
          <div class="footer-contact text-end">
            <p><i class="bi bi-geo-alt me-2"></i> 285 Đội Cấn, Ba Đình, Hà Nội</p>
            <p><i class="bi bi-telephone me-2"></i> +84 123 456 789</p>
            <p><i class="bi bi-envelope me-2"></i> info@hlearnhub.com</p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="container copyright text-center mt-4">
      <p>&copy; <span>2025</span> <strong>HlearnHub</strong>. All Rights Reserved</p>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Initialize tooltips -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
      });
    });
  </script>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>

  <!-- Bootstrap JS (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyAWXMEwMPSyMBVf4LikdsVCZ0kN4BhYB6E",
    authDomain: "hlearnhub-testing.firebaseapp.com",
    projectId: "hlearnhub-testing",
    messagingSenderId: "1054297107041",
    appId: "1:1054297107041:web:e2e985461b9ac570441820"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  document.addEventListener("DOMContentLoaded", async () => {
  const uid = localStorage.getItem("uid"); // kiểm tra uid từ localStorage xem có không
  if (!uid) {
    console.log("Chưa đăng nhập");
    return;
  }

  try {
    const userRef = db.collection("users").doc(uid);
    const doc = await userRef.get();
    
    if (!doc.exists) {
      console.log("Không tìm thấy dữ liệu người dùng");
      return;
    }

    const userData = doc.data();
    
    // Tạo object chứa các id và giá trị mặc định
    const userElements = {
      'user-nickname': userData.fullName || "",
      'user-name': userData.fullName || "Không có tên",
      'user-accname': userData.fullName || "Tài khoản của bạn", 
      'user-birthday': userData.birthDate || "Không có ngày sinh",
      'user-major': userData.departmentCode || "Không có ngành học",
      'user-course': userData.course || "Không có khóa học",
      'user-gpa': userData.recentGPA || "0",
      'user-cpa': userData.cpa || "0",
      'user-completedStudy': userData.completedStudySessions || "0",
      'user-completedTeach': userData.completedTeachingSessions || "0",
      'user-sdt': userData.phoneNumber || "Không có số điện thoại"
    };

    // Cập nhật từng phần tử một cách an toàn, tạo thành các cặp [id,value]
    Object.entries(userElements).forEach(([id, value]) => {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = value;
      } else {
        console.log(`Không tìm thấy phần tử có id: ${id}`);
      }
    });

    // Hiển thị số sao dựa trên field Star
    const starRating = userData.Star || 0;
    const starsContainer = document.getElementById('average-stars');
    const ratingNumber = document.getElementById('average-rating');
    
    // Tạo HTML cho sao
    let starsHTML = '';
    const fullStars = Math.floor(starRating);
    const hasHalfStar = starRating % 1 >= 0.5;

    for (let i = 1; i <= 5; i++) {
      if (i <= fullStars) {
        starsHTML += '<i class="bi bi-star-fill"></i>';
      } else if (i === fullStars + 1 && hasHalfStar) {
        starsHTML += '<i class="bi bi-star-half"></i>';
      } else {
        starsHTML += '<i class="bi bi-star"></i>';
      }
    }

    starsContainer.innerHTML = starsHTML;
    ratingNumber.textContent = `${starRating.toFixed(1)}/5`;

    // Load reviews
    await loadReviews(uid);

  } catch (err) {
    console.error("Lỗi khi lấy dữ liệu người dùng:", err);
  }
});

async function loadReviews(uid) {
  try {
    const reviewsList = document.getElementById('reviews-list');
    
    // Lấy tất cả đánh giá từ subcollection reviews
    const reviewsQuery = db.collection("users").doc(uid).collection("reviews").orderBy("createdAt", "desc");
    const reviewsSnapshot = await reviewsQuery.get();

    if (reviewsSnapshot.empty) {
      reviewsList.innerHTML = '<p class="text-center text-muted">Chưa có đánh giá nào.</p>';
      return;
    }

    let reviewsHTML = '';
    for (const reviewDoc of reviewsSnapshot.docs) {
      const review = reviewDoc.data();
      
      // Lấy thông tin người đánh giá
      const reviewerDoc = await db.collection("users").doc(review.reviewerId).get();
      const reviewerData = reviewerDoc.data();
      
      // Tạo HTML cho sao
      let starsHTML = '';
      const fullStars = Math.floor(review.rating);
      const hasHalfStar = review.rating % 1 !== 0;

      for (let i = 1; i <= 5; i++) {
        if (i <= fullStars) {
          starsHTML += '<i class="bi bi-star-fill"></i>';
        } else if (i === fullStars + 1 && hasHalfStar) {
          starsHTML += '<i class="bi bi-star-half"></i>';
        } else {
          starsHTML += '<i class="bi bi-star"></i>';
        }
      }

      // Format ngày đánh giá
      const reviewDate = review.createdAt ? new Date(review.createdAt.toDate()).toLocaleDateString('vi-VN') : 'Không có ngày';

      reviewsHTML += `
        <div class="review-item">
          <div class="stars mb-2">
            ${starsHTML}
          </div>
          <p class="review-text mb-1">${review.content}</p>
          <p class="review-author text-end">
            - ${reviewerData.fullName || 'Người dùng'} 
            (${review.reviewerRole === 'student' ? 'Học sinh' : 'Gia sư'})
            <br>
            <small class="text-muted">${reviewDate}</small>
          </p>
        </div>
      `;
    }

    reviewsList.innerHTML = reviewsHTML;
  } catch (error) {
    console.error("Lỗi khi tải đánh giá:", error);
    document.getElementById('reviews-list').innerHTML = 
      '<p class="text-center text-danger">Đã xảy ra lỗi khi tải đánh giá.</p>';
  }
}

document.getElementById('logout-btn').addEventListener('click', async (e) => {
    e.preventDefault();
    localStorage.removeItem("uid");
    window.location.href = "/logout";
  });

  
  </script>
</body>

</html>